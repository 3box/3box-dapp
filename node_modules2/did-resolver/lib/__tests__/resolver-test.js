'use strict';

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _resolver = require('../resolver');

var _resolver2 = _interopRequireDefault(_resolver);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

describe('resolver', function () {
  describe('parse()', function () {
    it('returns parts', function () {
      expect((0, _resolver.parse)('did:uport:2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX')).toEqual({ method: 'uport', id: '2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX', did: 'did:uport:2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX' });
      expect((0, _resolver.parse)('did:uport:2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX/some/path')).toEqual({ method: 'uport', id: '2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX', did: 'did:uport:2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX/some/path', path: '/some/path' });
      expect((0, _resolver.parse)('did:uport:2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX#fragment=123')).toEqual({ method: 'uport', id: '2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX', did: 'did:uport:2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX#fragment=123', fragment: 'fragment=123' });
      expect((0, _resolver.parse)('did:uport:2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX/some/path#fragment=123')).toEqual({ method: 'uport', id: '2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX', did: 'did:uport:2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX/some/path#fragment=123', path: '/some/path', fragment: 'fragment=123' });
    });

    it('fails if non compliant', function () {
      expect(function () {
        return (0, _resolver.parse)();
      }).toThrowError('Missing DID');
      expect(function () {
        return (0, _resolver.parse)('');
      }).toThrowError('Missing DID');
      expect(function () {
        return (0, _resolver.parse)('did:');
      }).toThrowError('Invalid DID did:');
      expect(function () {
        return (0, _resolver.parse)('did:uport');
      }).toThrowError('Invalid DID did:uport');
      expect(function () {
        return (0, _resolver.parse)('did:uport:');
      }).toThrowError('Invalid DID did:uport:');
      expect(function () {
        return (0, _resolver.parse)('did:uport:1234_12313***');
      }).toThrowError('Invalid DID did:uport:1234_12313***');
      expect(function () {
        return (0, _resolver.parse)('2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX');
      }).toThrowError('Invalid DID 2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX');
    });
  });

  describe('resolve', function () {
    (0, _resolver.registerMethod)('example', function () {
      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(did, parsed) {
        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                return _context.abrupt('return', {
                  '@context': 'https://w3id.org/did/v1',
                  id: did
                });

              case 1:
              case 'end':
                return _context.stop();
            }
          }
        }, _callee, undefined);
      }));

      return function (_x, _x2) {
        return _ref.apply(this, arguments);
      };
    }());

    it('fails on unhandled methods', (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {
      return _regenerator2.default.wrap(function _callee2$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              _context2.next = 2;
              return expect((0, _resolver2.default)('did:borg:2nQtiQG6Cgm1GYTBaaKAgr76uY7iSexUkqX')).rejects.toEqual(new Error('Unsupported DID method: \'borg\''));

            case 2:
            case 'end':
              return _context2.stop();
          }
        }
      }, _callee2, undefined);
    })));

    it('fails on parse error', (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3() {
      return _regenerator2.default.wrap(function _callee3$(_context3) {
        while (1) {
          switch (_context3.prev = _context3.next) {
            case 0:
              _context3.next = 2;
              return expect((0, _resolver2.default)('did:borg:')).rejects.toEqual(new Error('Invalid DID did:borg:'));

            case 2:
            case 'end':
              return _context3.stop();
          }
        }
      }, _callee3, undefined);
    })));

    it('resolves did document', (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee4() {
      return _regenerator2.default.wrap(function _callee4$(_context4) {
        while (1) {
          switch (_context4.prev = _context4.next) {
            case 0:
              _context4.next = 2;
              return expect((0, _resolver2.default)('did:example:123456789')).resolves.toEqual({
                '@context': 'https://w3id.org/did/v1',
                id: 'did:example:123456789'
              });

            case 2:
            case 'end':
              return _context4.stop();
          }
        }
      }, _callee4, undefined);
    })));
  });
});